# 模型数据接口规范

本文档定义了贝叶斯模型所需的 `datas` 数据字典和 `config` 配置文件的完整规范。

## 一、datas 数据字典

所有训练数据放在 `datas['train_data']` 下。

### 1.1 维度信息

```python
train_data = datas['train_data']

train_data['n_obs']         # int: 观测总数（选手-周 组合）
train_data['n_weeks']       # int: 周总数（所有赛季累计）
train_data['n_celebs']      # int: 名人总数
train_data['n_pros']        # int: 职业舞者总数
train_data['n_seasons']     # int: 赛季总数（用于交叉验证）
```

### 1.2 索引数组（用于分层结构）

所有索引从 0 开始，类型为 `np.int32`。

```python
train_data['celeb_idx']     # shape: [n_obs], 每条观测对应的名人ID
train_data['pro_idx']       # shape: [n_obs], 每条观测对应的舞者ID
train_data['week_idx']      # shape: [n_obs], 每条观测对应的周ID（全局唯一）
train_data['season_idx']    # shape: [n_obs], 每条观测对应的赛季ID（用于交叉验证）
```

### 1.3 特征矩阵

所有特征矩阵类型为 `np.float32`，所有连续特征需标准化（均值0，标准差1）。

| 特征矩阵 | 形状 | 说明 |
|----------|------|------|
| `X_celeb` | [n_celebs, ?] | 名人特征 |
| `X_pro` | [n_pros, ?] | 舞者特征 |
| `X_obs` | [n_obs, ?] | 观测级特征 |

每个特征矩阵需附带名称列表：
```python
train_data['X_celeb_names']  # list[str]
train_data['X_pro_names']    # list[str]
train_data['X_obs_names']    # list[str]
```

### 1.4 淘汰规则相关数据（似然函数用）

用于计算综合得分 $S_{i,w}$，与两种淘汰规则对应：

```python
# 百分比法 (rule_method=1): S = judge_score_pct + P_fan
train_data['judge_score_pct']   # shape: [n_obs], 评委分占当周总分的比例

# 排名法 (rule_method=0): S = judge_rank_score + fan_rank_score
train_data['judge_rank_score']  # shape: [n_obs], 评委排名分 = (n_contestants - rank) / (n_contestants - 1)
```

**注意**：这些不是预测 μ 的特征，是赛制规则计算淘汰时的输入。

### 1.5 周级结构信息（似然函数需要）

```python
train_data['week_data']         # list[dict], 长度为 n_weeks
```

每个元素的结构：
```python
{
    'obs_mask': np.ndarray,       # shape: [n_obs], bool, 该周参赛选手的掩码
    'n_contestants': int,          # 该周参赛人数
    'n_eliminated': int,           # 该周淘汰人数
    'eliminated_mask': np.ndarray, # shape: [n_obs], bool, 被淘汰选手的掩码
    'rule_method': int,            # 0=排名法, 1=百分比法
    'judge_save_active': bool,     # 是否有评委拯救环节
    'season': int,                 # 该周所属的赛季索引（从0开始）
    'week': int,                   # 该周在赛季内的周数（从0开始）
}
```

---

## 二、config 配置文件

```yaml
# config.yaml

model:
  # Student-T 分布
  use_student_t: true
  student_t_nu: 5.0

  # 样条设置（从 X_obs_names 中选）
  spline_features:
    - z_score
    - weeks_survived
  n_spline_knots: 5
  spline_degree: 3

  # 正则化
  use_horseshoe: true

  # 似然函数
  tau_init: 1.0
  learn_tau: true

  # 约束
  sum_to_zero: true

prior:
  sigma_celeb: { a: 2.0, b: 1.0 }
  sigma_pro: { a: 2.0, b: 1.0 }
  beta_celeb_scale: 2.5
  beta_pro_scale: 2.5
  beta_obs_scale: 2.5
  spline_smoothing_scale: 1.0

sampling:
  n_chains: 4
  n_tune: 1000
  n_samples: 2000
  target_accept: 0.9
  random_seed: 42
  cores: 4

output:
  dir: outputs/model
  save_trace: true
```

---

## 三、示例数据结构

```python
datas = {
    'train_data': {
        # 维度
        'n_obs': 100,
        'n_weeks': 30,
        'n_celebs': 36,
        'n_pros': 15,

        # 索引
        'celeb_idx': np.array([...], dtype=np.int32),   # [n_obs]
        'pro_idx': np.array([...], dtype=np.int32),     # [n_obs]
        'week_idx': np.array([...], dtype=np.int32),    # [n_obs]
        'season_idx': np.array([...], dtype=np.int32),  # [n_obs]

        # 特征矩阵
        'X_celeb': np.array([...], dtype=np.float32),   # [n_celebs, ?]
        'X_pro': np.array([...], dtype=np.float32),     # [n_pros, ?]
        'X_obs': np.array([...], dtype=np.float32),     # [n_obs, ?]

        # 特征名称
        'X_celeb_names': [...],
        'X_pro_names': [...],
        'X_obs_names': [...],

        # 淘汰规则相关
        'judge_score_pct': np.array([...], dtype=np.float32),   # 百分比法用
        'judge_rank_score': np.array([...], dtype=np.float32),  # 排名法用

        # 周级数据
        'week_data': [
            {
                'obs_mask': np.array([...], dtype=bool),
                'n_contestants': 12,
                'n_eliminated': 1,
                'eliminated_mask': np.array([...], dtype=bool),
                'rule_method': 1,
                'judge_save_active': False,
            },
            # ...
        ]
    }
}
```

---

## 四、数据验证清单

请确保数据满足以下条件：

1. **维度一致性**
   - `celeb_idx`, `pro_idx`, `week_idx` 长度均为 `n_obs`
   - `X_celeb` 第一维为 `n_celebs`
   - `X_pro` 第一维为 `n_pros`
   - `X_obs` 第一维为 `n_obs`
   - `week_data` 长度为 `n_weeks`

2. **索引范围**
   - `celeb_idx` 值在 `[0, n_celebs)` 内
   - `pro_idx` 值在 `[0, n_pros)` 内
   - `week_idx` 值在 `[0, n_weeks)` 内

3. **数据类型**
   - 索引数组：`np.int32`
   - 特征矩阵：`np.float32`
   - 掩码数组：`bool`

4. **标准化**
   - 连续特征均值接近 0，标准差接近 1

5. **淘汰数据一致性**
   - 所有 `week_data[w]['eliminated_mask'].sum()` 等于 `week_data[w]['n_eliminated']`

6. **赛季索引**
   - `season_idx` 长度为 `n_obs`
   - `season_idx` 值在 `[0, n_seasons)` 内

---

## 五、交叉验证说明

采用**留一赛季法（Leave-One-Season-Out）**进行交叉验证：

1. 轮流将每个赛季作为测试集，其余赛季作为训练集
2. 在训练集上训练模型，在测试集上评估预测准确率
3. 计算所有折的平均指标

**数据划分方式**：
```python
for test_season in range(n_seasons):
    train_mask = (season_idx != test_season)
    test_mask = (season_idx == test_season)
    # 用 train_mask 过滤训练数据
    # 用 test_mask 过滤测试数据
```

**评估指标**：
- **准确率**：正确预测淘汰者的周数 / 总周数
- **Brier Score**：概率预测的校准度，越低越好
