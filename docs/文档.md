# 2026 MCM Problem C - "与星共舞"粉丝投票预测建模方案

## 一、问题背景与建模目标

### 1.1 问题描述

"与星共舞"（Dancing with the Stars）是一档竞技真人秀节目，名人选手与职业舞者搭档参赛。每周比赛后，选手的去留由**评委评分**和**观众投票**共同决定。然而，**观众投票数据从未公开**，这使得粉丝投票的影响机制成为一个"黑箱"。

### 1.2 核心挑战

1. **无标签数据**：粉丝投票数（Fan Votes）不可直接观测
2. **复杂赛制**：不同赛季采用不同的淘汰规则（排名法 vs 百分比法）
3. **多因素交互**：选手人气受静态特征（年龄、行业）、动态表现（评委分、进步趋势）、竞争环境等多重因素影响
4. **时序依赖**：选手的粉丝基础随比赛进程演化

### 1.3 建模目标

构建一个**分层贝叶斯推断模型**，通过历史淘汰结果反向推断粉丝投票的潜在分布，并识别影响粉丝投票的关键因素。

**核心思路**：将粉丝投票视为**潜在变量（Latent Variable）**，通过贝叶斯推断最大化似然，使模型预测的淘汰结果与历史观测一致。

---

## 二、数据预处理

### 2.1 关键数据清洗

1. **性别统一处理**：将所有性别标识统一为二元变量（Male=1, Female=0），检索得到
2. **曾用名匹配**：处理选手在不同赛季使用不同名字的情况
3. **第34届特殊规则**：不考虑第二位舞者数据

### 2.2 缺失值处理

- **州人口数据**：国际选手填0、美国选手检索得到
- **舞者历史数据**：新舞者的 `pro_avg_rank` 用所有舞者的平均值填充
- **动态特征**：第一周的 `score_trend` 填0（无前一周数据）

---

## 三、特征工程设计

### 3.1 设计原则

特征工程遵循"**基础人气 + 动态表现 + 竞争环境**"的三层架构：

1. **静态特征**：捕捉选手的固有粉丝基础（Base Popularity）
2. **动态特征**：反映每周的技术表现和叙事变化
3. **环境特征**：控制赛制规则和竞争格局的影响

详情见文档，这部分很长，不要随意插入AI上下文

---

## 四、分层贝叶斯模型构建

### 4.1 核心建模思想

由于粉丝投票数（Fan Votes）不可直接观测，我们将其视为**潜在变量（Latent Variable）**。模型的基本逻辑链条为：

```
特征 → 潜在投票强度 → 周内得票占比 → 结合评委分执行赛制规则 → 观测到的淘汰结果
```

考虑到赛制中存在“人气黑马”或“爆冷淘汰”的极端情况，我们假设潜在投票强度 $V_{i,w}$ 服从**重尾的 Student-T 分布**：
$$V_{i,w} \sim \text{Student-T}(\nu, \mu_{i,w}, \sigma^2)$$
其中自由度 $\nu$（建议设为 3-7）控制对离群值的容忍度。当某选手表现极度异常时，重尾分布能防止模型参数受到剧烈干扰，增强鲁棒性。

其中 $\mu_{i,w}$ 是通过特征预测的期望投票强度，$\sigma^2$ 是模型的不确定性。

### 4.2 广义加性模型（GAM）框架

考虑到某些特征（如年龄、评委分）对粉丝投票的影响可能是**非线性**的，我们采用**广义加性模型（Generalized Additive Model, GAM）**：

$$\mu_{i,w} = \underbrace{\alpha_{c(i)}}_{\text{名人效应}} + \underbrace{\delta_{p(i)}}_{\text{舞者效应}} + \underbrace{\sum_{k=1}^{K} f_k(X_{dyn, k})}_{\text{动态非线性效应}} + \underbrace{\beta^T X_{lin}}_{\text{线性控制变量}} - \underbrace{\lambda_{ind} \cdot \log(\text{Count}(\dots))}_{\text{行业竞争惩罚}}$$

#### 4.2.1 名人效应（Hierarchical Random Intercept）

令 $\alpha_{c(i)} = \gamma^T Z_{c(i)} + \sigma_\alpha \cdot \tilde{\alpha}_{i}$，其中 $\tilde{\alpha}_{i} \sim \mathcal{N}(0, 1)$。

- $Z_{c(i)}$：选手 $i$ 的**静态特征向量**
- $\gamma$：静态特征的系数向量
- $\sigma_\alpha^2$：名人间的基础人气方差

**解释**：所有名人的基础人气来自一个共同分布，但受其静态特征调制。

#### 4.2.2 舞者效应（Hierarchical Random Intercept）

令 $\delta_{p(i)} = \theta^T W_{p(i)} + \sigma_\delta \cdot \tilde{\delta}_{i}$，其中 $\tilde{\delta}_{i} \sim \mathcal{N}(0, 1)$。

- $W_{p(i)}$：舞者 $p(i)$ 的静态特征向量
- $\theta$：舞者特征的系数向量
- $\sigma_\delta^2$：舞者间的影响力方差


由于模型核心采用 Softmax 函数将潜在投票强度 $V_{i,w}$ 转换为得票占比 $P_{i,w}$，而 Softmax 具有**平移不变性**（即对于任意常数 $C$，$\text{Softmax}(V) = \text{Softmax}(V+C)$）。若不加约束，各层拦截项参数会在 MCMC 迭代中沿实数轴无限漂移，导致模型不识别（Unidentifiability）。

我们通过施加**和为零约束（Sum-to-zero constraint）**来固定潜在强度的基准点：
$$\sum_{i=1}^{N_{celebs}} \alpha_{c(i)} = 0 \quad \text{与} \quad \sum_{j=1}^{N_{pros}} \delta_{p(j)} = 0$$

#### 4.2.3 动态非线性效应（Penalized Splines）

$$\sum_{k=1}^{K} f_k(X_{dyn, k})$$

- $X_{dyn, k}$：第 $k$ 个动态特征（如 `z_score`、`score_trend`、`weeks_survived`）
- $f_k(\cdot)$：通过**惩罚样条（Penalized Splines）** 学习的平滑函数

具体哪些特征非线性还没确定，只用少数

#### 4.2.4 线性控制变量

$$\beta^T X_{lin}$$

- $X_{lin}$：我们认为影响**基本是线性**的特征或0/1指示变量

#### 4.2.5 行业竞争惩罚
$$Penalty_{i,w} = \lambda_{ind} \cdot \frac{\text{Count}(\text{Industry}_i, \Omega_w) - 1}{|\Omega_w|}$$
**解释**：该项刻画了同质化竞争。如果场上同行业选手比例越高，粉丝被分流的压力越大；若全场仅有一名该行业选手，则惩罚为 0。

### 4.3 先验分布设计

#### 4.3.1 马蹄先验（Horseshoe Prior）

采用**正则化马蹄先验（Regularized Horseshoe Prior）**对系数进行收缩：
$$\beta_k \sim \mathcal{N}(0, \tau^2 \tilde{\lambda}_k^2), \quad \tilde{\lambda}_k^2 = \frac{c^2 \lambda_k^2}{c^2 + \tau^2 \lambda_k^2}$$
**工作原理**：
- $\tau$ 趋向于让大部分系数收缩到0（模型简化）
- $\tilde{\lambda}_k$ 允许真正重要的特征"逃脱"收缩（如 `teflon_factor`）

#### 4.3.2 样条平滑度先验

对于每个非线性函数 $f_k$，其平滑度由超参数 $\rho_k$ 控制：

$$\rho_k \sim \text{Cauchy}^+(0, 1)$$

**解释**：$\rho_k$ 越大，$f_k$ 越平滑（接近线性）；越小，越灵活（可能过拟合）。

#### 4.3.3 方差先验

$$\sigma_\alpha^2, \sigma_\delta^2, \sigma^2 \sim \text{Inv-Gamma}(a, b)$$

使用弱信息先验（如 $a=2, b=1$），让数据主导推断。

---

## 五、竞争约束层：从强度到占比

### 5.1 Softmax 转换

为了体现同一场比赛中的**零和博弈**，我们使用 Softmax 函数将潜在强度转化为当周的**得票百分比估计值 $P_{i,w}$**：

$$P_{i,w} = \frac{\exp(\mu_{i,w})}{\sum_{j \in \Omega_w} \exp(\mu_{j,w})}$$

其中 $\Omega_w$ 是第 $w$ 周仍在场的所有选手集合。

**关键性质**：
1. $\sum_{i \in \Omega_w} P_{i,w} = 1$（完美刻画粉丝在特定候选人池中的选择偏好）
2. $P_{i,w}$ 对 $\mu_{i,w}$ 的变化敏感度取决于竞争格局

### 5.2 物理意义

- **高 $\mu_{i,w}$**：该选手在当周具有强大的粉丝动员能力
- **Softmax 归一化**：即使某选手绝对人气高，若同场竞争者更强，其 $P_{i,w}$ 仍可能较低

---

## 六、 自定义似然函数：多重淘汰与动态赛制模拟

在模型推断中，我们而是根据历史观测数据提供的**当周淘汰人数 $N_w$**（$N_w \in \{0, 1, 2, \dots\}$）来执行模拟过程。

### 6.1 动态赛制模拟引擎 (Dynamic Rule Engine)

在 MCMC 的每一步迭代中，模型根据预测的得票占比 $P_{i,w}$ 和评委分 $J_{i,w}$ 计算选手的综合评分 $S_{i,w}$，然后根据该周对应的 $N_w$ 识别淘汰者。

### 6.1 统一尺度下的综合得分计算

#### 6.1.1 百分比法（Percent Method, 适用于 S3–S27）
直接累加评委分占比与粉丝票占比：
$$S_{i,w} = \underbrace{\frac{J_{i,w}}{\sum_{j \in \Omega_w} J_{j,w}}}_{\text{评委分贡献}} + \underbrace{P_{i,w}^{fan}}_{\text{粉丝票贡献}}$$
*注：由于两项占比之和最大为 2，最小接近 0，符合统一尺度。*

#### 6.1.2 排名法（Rank Method, 适用于 S1-2, S28+）
由于排名是序数（1为最优），需将其转换为“相对优越度”：
1. **评委排名分**：$R'_{judge}(i) = \frac{|\Omega_w| - \text{Rank}_{judge}(i)}{|\Omega_w| - 1}$
2. **粉丝排名分**：$R'_{fan}(i) = \frac{|\Omega_w| - \text{Rank}_{fan}(i)}{|\Omega_w| - 1}$
   *(其中 Rank=1 时分值为 1，Rank=底端时分值为 0)*
3. **计算总分**：
$$S_{i,w} = R'_{judge}(i) + R'_{fan}(i)$$

### 6.2 评委拯救修正（Bottom Two Rule）
若该周存在评委拯救，对于进入底部的两名选手 $\{i_1, i_2\}$，这里简化处理，假设其最终效用值受技术分偏移量修正：
$$S'_{i,w} = S_{i,w} + \mathbb{I}(i \in \text{Bottom 2}) \cdot \theta_{save} \cdot (J_{i,w} - \bar{J}_{bottom2})$$
其中 $\theta_{save} > 0$ 为待估参数，代表评委对技术分的偏好强度。

### 6.3 序数似然函数 (Rank-Ordered Log-Likelihood)

由于观测数据仅告知“谁被淘汰了”（即谁的 $S_{i,w}$ 最小），我们采用 **负向 Plackett-Luce 模型**。模型的目标是：**最大化“实际淘汰者”具有“最低生存效用”的概率。**

定义第 $w$ 周实际淘汰的选手集合为 $\mathcal{E}_w^{obs}$，当周总淘汰人数为 $N_w$。

#### 6.3.1 单人淘汰场景 ($N_w = 1$)
设 $e$ 为当周实际淘汰者，其似然贡献为：
$$\mathcal{L}_w = P(i=e \text{ is minimum}) = \frac{\exp(-\tau \cdot S_{e,w})}{\sum_{j \in \Omega_w} \exp(-\tau \cdot S_{j,w})}$$

#### 6.3.2 多人淘汰场景 ($N_w > 1$)
假设淘汰是有序发生的（得分最低的先被选出），则该周对数似然为：
$$\log \mathcal{L}_w = \sum_{e \in \mathcal{E}_w^{obs}} \left( -\tau S_{e,w} - \log \sum_{j \in \Omega_{w, \text{rem}}} \exp(-\tau S_{j,w}) \right)$$
其中 $\Omega_{w, \text{rem}}$ 是剔除掉在该步骤前已被“选出”的淘汰者后的剩余选手池。

#### 6.3.3 参数解释
*   **温度参数 $\tau$ (Inverse Temperature)**：
    *   $\tau$ 越大，模型对 $S_{i,w}$ 的差异越敏感（即 $S$ 的微小差异就会导致淘汰概率的剧增）。
    *   $\tau$ 较小时，允许模型存在一定的容错空间（即偶尔的高分淘汰）。
*   **负号的物理意义**：由于我们定义的 $S$ 越大越安全，因此在似然函数中使用 $-S$，使得 $S$ 越小的选手在 Softmax 运算中获得越高的“被淘汰概率”。

### 6.4 最终目标函数
结合所有周次，通过 MCMC 最大化后验分布：
$$\log P(\Theta | \text{Data}) = \sum_{w=1}^W \log \mathcal{L}_w + \log P(\Theta_{priors}) - \text{Penalty}(\text{Overfitting})$$*

实际实现加一个 $\epsilon$ ，一个极小的惩罚值（如 $10^{-6}$），确保 MCMC 不会卡在零似然区域。
### 6.5 特殊情况处理
- **零淘汰周 ($N_w = 0$)**：该周似然值贡献为常数（不提供参数更新信号，或仅验证没有人分值过低）。

---

## 七、模型验证与诊断

### 7.1 后验预测检验（Posterior Predictive Checks）

**目标**：确保模型能生成与真实数据相似的淘汰结果分布。

**步骤**：
1. 从后验分布中抽取参数样本 $\theta^{(s)}$
2. 对每个样本，模拟整个赛季的淘汰过程，生成 $E_w^{sim}$
3. 比较模拟分布与真实分布：
   - **淘汰周数分布**：模型是否正确预测了"强者晋级、弱者早退"的模式？
   - **Teflon 选手识别率**：模型是否能复现"技术分低但存活久"的案例？
   - **行业分布**：各行业选手的平均存活周数是否与历史一致？

**评估指标**：
- **准确率**：$\frac{\text{正确预测的淘汰周数}}{\text{总周数}}$
- **Brier Score**：衡量概率预测的校准度

### 7.2 非线性关系可视化

对于每个样条函数 $f_k$，绘制其**后验均值曲线**和**95% 置信区间**：

**示例分析**：
-  ** $f(\text{z_score})$**：
  - 若曲线在低分区陡峭上升，说明"同情投票"效应存在
  - 若在高分区趋于平缓，说明技术分的边际效应递减

- **$f(\text{age})$**：
  - 若呈倒U型，说明存在"最受欢迎年龄段"
  - 若单调递减，说明年轻选手更受青睐

- **$f(\text{weeks_survived})$**：
  - 若早期波动大、后期平稳，说明粉丝基础在赛程中固化

### 7.3 特征重要性分析

通过马蹄先验的后验分布，识别关键特征：

1. **计算每个系数的后验均值和95% 可信区间**
2. **若可信区间不包含0**，则该特征显著
3. **按 $|\beta_k|$ 排序**，识别 Top 10 影响因素

**预期发现**：
- `teflon_factor` 应有极高的正系数（强粉丝票信号）
- `z_score` 可能为负（技术分低反而激发同情票）
- `log_us_state_pop` 为正（大州选手有地域优势）

### 7.4 交叉验证

**留一赛季法（Leave-One-Season-Out）**：
1. 用 S1–S32 训练，预测 S33 的淘汰结果
2. 轮流留出每个赛季，计算平均预测准确率

**目标**：验证模型的泛化能力，避免过拟合特定赛季的特殊情况。




TODO:

评委分数预测，作为baseline对比