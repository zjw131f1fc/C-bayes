# 实验手册

## 2026-01-31 实验记录

### 启用样条非线性特征

**修改：**
- 观测级样条：`z_score_x_cumulative_avg_score`
- 名人级样条：`age`
- 扩展代码支持名人级样条（`celeb_spline_features`）

**结果：**

| 指标 | 修改前 | 修改后 |
|------|--------|--------|
| Spline贡献 std | 0.000 | 0.058 |
| Linear贡献 std | 3.495 | 3.418 |

**样条效果：**
- `z_score_x_cumulative_avg_score`：波浪形，峰值+0.22（x≈0.5），谷值-0.22（x≈4-5）
- `age`：波浪形，年轻/年长正效应，中年负效应（-0.52）

---

### 显著特征（线性）

| 特征 | 系数 |
|------|------|
| `teflon_factor` | +5.0 |
| `teflon_factor_x_times_in_bottom` | +3.4 |
| `cumulative_avg_score` | +2.3 |
| `times_in_bottom` | -2.1 |

---

### 其他发现

- 女舞者有正效应（delta 0~0.6），男舞者有负效应（delta -0.5~-0.1）
- 淘汰预测：median=0（大部分正确）

---

## 95% CI 过宽问题分析与解决

### 问题发现

第一问可视化中，后验估计轨迹图的 95% 置信区间过宽。

### 方差分解分析

对原始模型（无 Horseshoe）进行方差分解：

| 来源 | 方差 | 占比 |
|------|------|------|
| **Linear (线性特征)** | 20.28 | **85.0%** |
| Alpha (名人效应) | 2.25 | 9.4% |
| Delta (舞者效应) | 0.91 | 3.8% |
| Obs_noise | 0.41 | 1.7% |

**结论：线性特征贡献了 85% 的方差，是 CI 过宽的主要原因。**

### 方案1：普通 Horseshoe 先验

**实现：**
```python
tau_hs ~ HalfCauchy(1.0)           # 全局收缩
lambda_hs ~ HalfCauchy(1.0)        # 局部收缩（每个特征）
beta_obs ~ Normal(0, tau_hs * lambda_hs)
```

**结果：失败**

| 指标 | 原始 | Horseshoe |
|------|------|-----------|
| mu std | 5.97 | 39.51 (↑6.6倍) |
| beta_obs std | 2.27 | 17.54 (↑7.7倍) |
| lambda_hs mean | - | 7.34 |

**问题：** HalfCauchy(1.0) 尾部太重，当数据支持大系数时，λ 没有收缩反而变大。

### 方案2：Regularized Horseshoe 先验（推荐）

**实现：**
```python
# 参考: Piironen & Vehtari (2017)
tau_hs ~ HalfCauchy(1.0)           # 全局收缩
lambda_hs ~ HalfCauchy(1.0)        # 局部收缩
c2_hs ~ InverseGamma(2.0, 1.0)     # Slab 方差（限制大系数）

# Regularized 局部方差
lambda_tilde2 = c2 * lambda2 / (c2 + tau2 * lambda2)
beta_obs ~ Normal(0, tau_hs * sqrt(lambda_tilde2))
```

**原理：**
- 当 λ 很大时：λ̃² → c²/τ²（被 slab 限制）
- 当 λ 很小时：λ̃² → λ²（正常收缩）

**结果：** 待测试

---

### 备选方案

**方案B：关闭 Horseshoe，降低 beta_obs_scale**
```yaml
model:
  use_horseshoe: false
prior:
  beta_obs_scale: 0.5  # 从 2.5 降到 0.5
```

**方案C：收紧所有先验**
```yaml
prior:
  sigma_celeb: { a: 3.0, b: 1.0 }
  beta_celeb_scale: 1.0
  beta_obs_scale: 1.0
```

**方案D：关闭 obs_noise**
```yaml
model:
  obs_noise: false
```
