# 实验手册

## 2026-01-31 实验记录

### 启用样条非线性特征

**修改：**
- 观测级样条：`z_score_x_cumulative_avg_score`
- 名人级样条：`age`
- 扩展代码支持名人级样条（`celeb_spline_features`）

**结果：**

| 指标 | 修改前 | 修改后 |
|------|--------|--------|
| Spline贡献 std | 0.000 | 0.058 |
| Linear贡献 std | 3.495 | 3.418 |

**样条效果：**
- `z_score_x_cumulative_avg_score`：波浪形，峰值+0.22（x≈0.5），谷值-0.22（x≈4-5）
- `age`：波浪形，年轻/年长正效应，中年负效应（-0.52）

---

### 显著特征（线性）

| 特征 | 系数 |
|------|------|
| `teflon_factor` | +5.0 |
| `teflon_factor_x_times_in_bottom` | +3.4 |
| `cumulative_avg_score` | +2.3 |
| `times_in_bottom` | -2.1 |

---

### 其他发现

- 女舞者有正效应（delta 0~0.6），男舞者有负效应（delta -0.5~-0.1）
- 淘汰预测：median=0（大部分正确）

---

## 95% CI 过宽问题分析与解决

### 问题发现

第一问可视化中，后验估计轨迹图的 95% 置信区间过宽。

### 方差分解分析

对原始模型（无 Horseshoe）进行方差分解：

| 来源 | 方差 | 占比 |
|------|------|------|
| **Linear (线性特征)** | 20.28 | **85.0%** |
| Alpha (名人效应) | 2.25 | 9.4% |
| Delta (舞者效应) | 0.91 | 3.8% |
| Obs_noise | 0.41 | 1.7% |

**结论：线性特征贡献了 85% 的方差，是 CI 过宽的主要原因。**

### 方案1：普通 Horseshoe 先验

**实现：**
```python
tau_hs ~ HalfCauchy(1.0)           # 全局收缩
lambda_hs ~ HalfCauchy(1.0)        # 局部收缩（每个特征）
beta_obs ~ Normal(0, tau_hs * lambda_hs)
```

**结果：失败**

| 指标 | 原始 | Horseshoe |
|------|------|-----------|
| mu std | 5.97 | 39.51 (↑6.6倍) |
| beta_obs std | 2.27 | 17.54 (↑7.7倍) |
| lambda_hs mean | - | 7.34 |

**问题：** HalfCauchy(1.0) 尾部太重，当数据支持大系数时，λ 没有收缩反而变大。

### 方案2：Regularized Horseshoe 先验（推荐）

**实现：**
```python
# 参考: Piironen & Vehtari (2017)
tau_hs ~ HalfCauchy(1.0)           # 全局收缩
lambda_hs ~ HalfCauchy(1.0)        # 局部收缩
c2_hs ~ InverseGamma(2.0, 1.0)     # Slab 方差（限制大系数）

# Regularized 局部方差
lambda_tilde2 = c2 * lambda2 / (c2 + tau2 * lambda2)
beta_obs ~ Normal(0, tau_hs * sqrt(lambda_tilde2))
```

**原理：**
- 当 λ 很大时：λ̃² → c²/τ²（被 slab 限制）
- 当 λ 很小时：λ̃² → λ²（正常收缩）

**结果：** 仍有漏斗问题，采样速度不均匀

---

### 方案3：非中心化参数化 + Regularized Horseshoe（最终方案）

**实现：**
```python
# 非中心化参数化解决漏斗问题
tau_hs ~ HalfCauchy(1.0)
lambda_hs_raw ~ HalfNormal(1.0)    # 改用 HalfNormal 更稳定
c2_hs ~ InverseGamma(2.0, 1.0)

lambda_tilde2 = c2 * lambda2 / (c2 + tau2 * lambda2)
scale = tau_hs * sqrt(lambda_tilde2)

# 非中心化：解耦 scale 和 beta
beta_raw ~ Normal(0, 1)            # 标准正态，几何简单
beta_obs = scale * beta_raw        # 确定性变换
```

**结果：成功**

| 指标 | 原始 | 普通Horseshoe | 非中心化Horseshoe |
|------|------|---------------|-------------------|
| Acc_A | 0.55 | 0.587 | **0.598** |
| Acc_B | 0.49 | 0.539 | **0.562** |
| mu std | 5.97 | 39.51 | **3.09** (↓48%) |
| beta_obs std | 2.27 | 17.54 | **1.12** (↓51%) |
| P_fan var | 0.024 | - | **0.013** (↓47%) |
| lambda_hs mean | - | 7.34 | **0.5-1.5** |

**改进：**
- 方差大幅降低（约50%）
- 准确率提升
- 采样速度均匀
- 收缩有效（lambda_hs 在合理范围）

---

### 备选方案

**方案B：关闭 Horseshoe，降低 beta_obs_scale**
```yaml
model:
  use_horseshoe: false
prior:
  beta_obs_scale: 0.5  # 从 2.5 降到 0.5
```

**方案C：收紧所有先验**
```yaml
prior:
  sigma_celeb: { a: 3.0, b: 1.0 }
  beta_celeb_scale: 1.0
  beta_obs_scale: 1.0
```

**方案D：关闭 obs_noise**
```yaml
model:
  obs_noise: false
```

---

## TODO

- [ ] 行业竞争惩罚未实现（文档公式：$Penalty = \lambda_{ind} \cdot \frac{Count(Industry) - 1}{|\Omega_w|}$）
- [x] Regularized Horseshoe 先验测试（已完成，使用非中心化参数化）
- [x] 评委拯救修正（已实现）
- [ ] `weeks_survived` 非线性
- [ ] 交叉验证
- [ ] **第一问图表一纵坐标问题**：后验轨迹图的 95% CI 看起来很宽，实际上是因为 P_fan 的取值范围本身很小（约 0.05-0.25），纵坐标需要调整显示范围或使用相对值

---

## 评委拯救修正（Judge Save Correction）

### 问题描述

当 `judge_save_active=True` 时（S28+赛季），淘汰机制为：
1. 综合分 S 最低的两人进入危险区（Bottom 2）
2. 评委选择保留其中一人，另一人被淘汰

原模型直接用 Plackett-Luce 建模"谁被淘汰"，没有考虑评委的选择偏好。

### 修正方案

根据文档 6.2 节，对危险区两人的 S 做修正：

$$S'_{i,w} = S_{i,w} + \mathbb{I}(i \in \text{Bottom 2}) \cdot \theta_{save} \cdot (J_{i,w} - \bar{J}_{bottom2})$$

其中：
- $\theta_{save} > 0$：评委对技术分的偏好强度（待估参数）
- $J_{i,w}$：选手 i 的评委分
- $\bar{J}_{bottom2}$：危险区两人的评委分均值

**物理意义**：评委倾向于保留技术分更高的选手。

### 实现

```python
# 配置
use_judge_save_correction: true
theta_save_scale: 1.0  # θ_save ~ HalfNormal(1.0)

# 似然函数修正
if judge_save_active:
    # 1. 找出 S 最低的两人
    bottom2_idx = argsort(S)[:2]

    # 2. 计算修正
    judge_mean_bottom2 = mean(judge[bottom2_idx])
    S_corrected = S + theta_save * (judge - judge_mean_bottom2)

    # 3. 只对危险区两人做 Plackett-Luce
    contestants = bottom2_mask
else:
    # 标准 Plackett-Luce
    contestants = all_contestants
```
